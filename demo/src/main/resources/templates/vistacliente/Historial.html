<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/historial.css}">
    <title>Historial de Compras</title>
    </head>
<body>
    <div class="floating-elements">
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">üõçÔ∏è ShopTracker</div>
            <div class="search-container">
                <div class="search-icon">üîç</div>
                <input type="text" class="search-input" placeholder="Buscar productos...">
            </div>
            <div class="user-info">
                <span>üë§ Mar√≠a Gonz√°lez</span>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">Mi Historial de Compras</h1>


        <div class="purchases-grid">
            <div class="purchase-card" th:each="item : ${compras}">
                <div class="purchase-header">
                    <input type="hidden" id="ventas" name="venta" th:value="${item.detallesVenta}">
                    <div class="purchase-date" th:text="${#temporals.format(item.fecha, 'dd/MM/yyyy')}" >24 Agosto 2025</div>
                    <div class="purchase-price" th:text="'$ '+${item.total}" >$589.99</div>
                </div>
                <div class="purchase-details">
                    <div class="product-info">
                        <div class="product-name" >xxxx xxxx x</div>
                        <div class="product-brand"  >Apple</div>
                    </div>
                    <div class="stock-badge" th:text="${#aggregates.sum(item.detallesVenta.![cantidad])+' Articulos'}">Stock: 12</div>
                </div>
            </div>
        </div>
        <br><br>
              <!-- Pagination -->
        <div class="pagination-container">
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center" >
                    <li class="page-item" th:each="pageNumber : ${pageNumbers}">
                        <a class="page-link" th:href="@{|/admin/admin?page=${pageNumber}|}" th:text="${pageNumber}"></a>
                    </li>
                    </ul>

            </nav>
        </div>

        <style>.pagination {
    list-style: none;
    padding-left: 0;
    display: flex;
    justify-content: center;
    gap: 5px;
}

.pagination li {
    list-style: none;
}

.page-link {
    display: block;
    padding: 0.375rem 0.75rem;
    color: #0d6efd;
    text-decoration: none;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.page-link:hover {
    color: #0a58ca;
    background-color: #e9ecef;
    border-color: #dee2e6;
}

#detailModal #detailImagen {
    width: 100%;
    text-align: center;
    margin: 15px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

#detailModal #detailImagen img {
    width: 100%;
    max-width: 300px;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 0 auto;
    display: block;
}</style>



    </div>

    <!-- Modal de detalles -->
    <div class="purchase-modal" id="purchaseModal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-header">
                <h2>Detalles de la Compra</h2>
                <div class="purchase-date-modal"></div>
            </div>
            <div class="modal-body">
                <table class="purchase-details-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Marca</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseDetailsBody">
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="total-label">Total</td>
                            <td class="total-amount"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Animaci√≥n suave para las tarjetas al hacer scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Funcionalidad del Modal
        const modal = document.getElementById('purchaseModal');
        const closeBtn = document.querySelector('.close-modal');
        
        // Agregar click event a todas las tarjetas de compra
        document.querySelectorAll('.purchase-card').forEach(card => {
            card.addEventListener('click', () => {
                ventas = card.querySelector('#ventas').value;


                const listaDetailsSale = parseDetailsSaleArray(ventas);

                console.log('Lista de DetailsSale parseada:', listaDetailsSale);
                console.log('N√∫mero de elementos:', listaDetailsSale.length);

                const date = card.querySelector('.purchase-date').textContent;
                const productName = card.querySelector('.product-name').textContent;
                const brandName = card.querySelector('.product-brand').textContent;
                const price = card.querySelector('.purchase-price').textContent.replace('$', '');
                
                // Mostrar fecha en el modal
                document.querySelector('.purchase-date-modal').textContent = date;
                
                // Simular datos de compra (aqu√≠ deber√≠as obtener los datos reales de tu backend)
                const purchaseDetails = [
                    {
                        name: "Cliente Regular", // Aqu√≠ podr√≠as poner el nombre real del cliente
                        brand: brandName,
                        product: productName,
                        quantity: 1,
                        price: parseFloat(price),
                        subtotal: parseFloat(price)
                    }
                ];
                
                // Limpiar y llenar la tabla
                const tbody = document.getElementById('purchaseDetailsBody');
                tbody.innerHTML = '';
                let total = 0;
                
                listaDetailsSale.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>xxx</td>
                        <td>${item.producto.marca.nombre}</td>
                        <td>${item.producto.nombre}</td>
                        <td>${item.cantidad}</td>
                        <td>$${item.precio.toFixed(2)}</td>
                        <td>$${item.subtotal.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                    total += item.subtotal;
                });
                
                // Actualizar total
                document.querySelector('.total-amount').textContent = `$${total.toFixed(2)}`;
                
                // Mostrar modal
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        });
        
        // Cerrar modal
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
        
        // Cerrar modal al hacer click fuera
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Funcionalidad de b√∫squeda
        const searchInput = document.querySelector('.search-input');
        const purchaseCards = document.querySelectorAll('.purchase-card');

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            purchaseCards.forEach(card => {
                const productName = card.querySelector('.product-name').textContent.toLowerCase();
                const productBrand = card.querySelector('.product-brand').textContent.toLowerCase();
                
                if (productName.includes(searchTerm) || productBrand.includes(searchTerm)) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeInUp 0.5s ease-out';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // Efecto de part√≠culas flotantes adicionales
        setInterval(() => {
            const particle = document.createElement('div');
            particle.style.cssText = `
                position: fixed;
                width: ${Math.random() * 6 + 2}px;
                height: ${Math.random() * 6 + 2}px;
                background: rgba(255,255,255,0.3);
                border-radius: 50%;
                top: 100vh;
                left: ${Math.random() * 100}vw;
                pointer-events: none;
                animation: floatUp ${Math.random() * 3 + 4}s linear forwards;
                z-index: -1;
            `;
            
            document.body.appendChild(particle);
            
            setTimeout(() => {
                particle.remove();
            }, 7000);
        }, 2000);

        // Agregar keyframe para part√≠culas
        const style = document.createElement('style');
        style.textContent = `
            @keyframes floatUp {
                to {
                    transform: translateY(-100vh);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);


        function parseDetailsSaleArray(str) {
    // Funci√≥n auxiliar para encontrar el cierre de par√©ntesis correspondiente
    function findClosingParen(str, startIndex) {
        let count = 0;
        for (let i = startIndex; i < str.length; i++) {
            if (str[i] === '(') count++;
            else if (str[i] === ')') {
                count--;
                if (count === 0) return i;
            }
        }
        return -1;
    }
    
    // Funci√≥n auxiliar para parsear un valor
    function parseValue(value) {
        value = value.trim();
        
        // Si es null
        if (value === 'null') return null;
        
        // Si es boolean
        if (value === 'true') return true;
        if (value === 'false') return false;
        
        // Si es n√∫mero
        if (!isNaN(value) && !isNaN(parseFloat(value))) {
            return parseFloat(value);
        }
        
        // Si es array vac√≠o o con elementos vac√≠os
        if (value === '[]' || value === '[,]') return [];
        
        // Si es un objeto anidado
        if (value.includes('(') && value.includes(')')) {
            return parseObjectString(value);
        }
        
        // Si es string
        return value;
    }
    
    // Funci√≥n para parsear un objeto individual
    function parseObjectString(str) {
        const objectMatch = str.match(/^(\w+)\(/);
        if (!objectMatch) return null;
        
        const objectName = objectMatch[1];
        const startContent = str.indexOf('(') + 1;
        const endContent = findClosingParen(str, str.indexOf('('));
        const content = str.substring(startContent, endContent);
        
        const result = { _type: objectName };
        
        // Parsear propiedades
        let i = 0;
        while (i < content.length) {
            // Encontrar el nombre de la propiedad
            const equalIndex = content.indexOf('=', i);
            if (equalIndex === -1) break;
            
            const propName = content.substring(i, equalIndex).trim();
            
            // Encontrar el valor de la propiedad
            let valueStart = equalIndex + 1;
            let valueEnd;
            
            // Si el siguiente car√°cter despu√©s del = es una letra seguida de (, es un objeto anidado
            const nextPart = content.substring(valueStart).trim();
            if (nextPart.match(/^\w+\(/)) {
                const openParen = nextPart.indexOf('(');
                const closeParen = findClosingParen(nextPart, openParen);
                valueEnd = valueStart + nextPart.length - nextPart.length + closeParen + 1;
            } else {
                // Buscar la siguiente coma que no est√© dentro de par√©ntesis
                let parenCount = 0;
                valueEnd = valueStart;
                while (valueEnd < content.length) {
                    if (content[valueEnd] === '(') parenCount++;
                    else if (content[valueEnd] === ')') parenCount--;
                    else if (content[valueEnd] === ',' && parenCount === 0) break;
                    valueEnd++;
                }
            }
            
            const valueStr = content.substring(valueStart, valueEnd).trim();
            result[propName] = parseValue(valueStr);
            
            i = valueEnd + 1;
            
            // Saltar espacios y comas
            while (i < content.length && (content[i] === ',' || content[i] === ' ')) {
                i++;
            }
        }
        
        return result;
    }
    
    // Extraer todos los objetos DetailsSale del string
    const detailsArray = [];
    let currentIndex = 0;
    
    while (currentIndex < str.length) {
        // Buscar el inicio de un DetailsSale
        const startPattern = str.indexOf('DetailsSale(', currentIndex);
        if (startPattern === -1) break;
        
        // Encontrar el final del objeto DetailsSale
        const openParen = str.indexOf('(', startPattern);
        const closeParen = findClosingParen(str, openParen);
        
        if (closeParen !== -1) {
            // Extraer el objeto completo
            const objectStr = str.substring(startPattern, closeParen + 1);
            const parsedObject = parseObjectString(objectStr);
            
            if (parsedObject) {
                detailsArray.push(parsedObject);
            }
            
            currentIndex = closeParen + 1;
        } else {
            break;
        }
    }
    
    return detailsArray;
}

        
    </script>
</body>
</html>